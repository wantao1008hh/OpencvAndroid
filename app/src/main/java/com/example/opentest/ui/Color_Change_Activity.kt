package com.example.opentest.ui

import android.os.Bundle
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import com.example.opentest.R
import com.example.opentest.opencv.ImageUtil
import com.example.opentest.util.TimberUtil
import kotlinx.android.synthetic.main.activity_color_change.*
import org.opencv.android.Utils
import org.opencv.core.Mat
import org.opencv.imgproc.Imgproc

class Color_Change_Activity : AppCompatActivity() {

    lateinit var realMat: Mat

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_color_change)

        var mat = Utils.loadResource(this, R.mipmap.linyuner1)

        realMat = Mat()
        Imgproc.cvtColor(mat, realMat, Imgproc.COLOR_BGR2RGB)


        iv1.setImageBitmap(ImageUtil.matToBitmap(realMat))

        btn1.setOnClickListener {
            reduceColor()
        }
    }

    /**
     * 遍历很慢，，，暂时找不到解决方案。
     */
    private fun reduceColor() {
        progress.visibility = View.VISIBLE
        var mat = realMat.clone()
        TimberUtil.logI("channels: " + mat.channels())
        Thread()
        {

            kotlin.run {
                for (i in 0 until mat.rows()) {
                    for (j in 0 until mat.cols()) {
                        if (mat.channels() == 3) {
                            var newR = mat[i, j][0] * 0.9
                            var newG = mat[i, j][1] * 1.1
                            var newB = mat[i, j][2] * 1.2
                            mat.put(i, j, newR, newG, newB)
                        }
                    }
                    var value = (i + 1) * 100 / mat.rows()
                    progress.progress = value
                    if (value >= 100) {
                        runOnUiThread {
                            progress.visibility = View.GONE
                            iv2.setImageBitmap(ImageUtil.matToBitmap(mat))
                        }
                    }
                }
            }
        }.start()
    }
}